<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ReactChildren API | Clog</title>
    <meta name="description" content="

React 提供了该API用于对每个reactElement进行遍历操作
// 该文件导出了
// React.children.map
// React.children.forEach
// React.children.count
// React.children.only
export {
  forEachChildren as forEach,
  mapChild ...">
    <meta name="generator" content="VuePress 1.3.1">
    
    
    <link rel="preload" href="/assets/css/0.styles.18c2a749.css" as="style"><link rel="preload" href="/assets/js/app.4b1e1b3d.js" as="script"><link rel="preload" href="/assets/js/6.90d8b0a4.js" as="script"><link rel="preload" href="/assets/js/13.d71f7fb4.js" as="script"><link rel="preload" href="/assets/js/75.9cd96759.js" as="script"><link rel="prefetch" href="/assets/js/1.d56f86e5.js"><link rel="prefetch" href="/assets/js/10.618b6d7a.js"><link rel="prefetch" href="/assets/js/11.59f5d7f5.js"><link rel="prefetch" href="/assets/js/12.e6eda927.js"><link rel="prefetch" href="/assets/js/14.29a562a6.js"><link rel="prefetch" href="/assets/js/15.4f4d6e84.js"><link rel="prefetch" href="/assets/js/16.5ab9252e.js"><link rel="prefetch" href="/assets/js/17.48db5f67.js"><link rel="prefetch" href="/assets/js/18.272c5b8f.js"><link rel="prefetch" href="/assets/js/19.c9e43428.js"><link rel="prefetch" href="/assets/js/20.e5f4711e.js"><link rel="prefetch" href="/assets/js/21.d2b26fab.js"><link rel="prefetch" href="/assets/js/22.ba442cb0.js"><link rel="prefetch" href="/assets/js/23.ba51e662.js"><link rel="prefetch" href="/assets/js/24.19d39f17.js"><link rel="prefetch" href="/assets/js/25.5142b57a.js"><link rel="prefetch" href="/assets/js/26.e6eb7937.js"><link rel="prefetch" href="/assets/js/27.ac6841a2.js"><link rel="prefetch" href="/assets/js/28.7c8307c8.js"><link rel="prefetch" href="/assets/js/29.8c95c4fa.js"><link rel="prefetch" href="/assets/js/30.635aaf7f.js"><link rel="prefetch" href="/assets/js/31.7b59d342.js"><link rel="prefetch" href="/assets/js/32.35ad53ae.js"><link rel="prefetch" href="/assets/js/33.6c299105.js"><link rel="prefetch" href="/assets/js/34.5f2e1be8.js"><link rel="prefetch" href="/assets/js/35.580b2561.js"><link rel="prefetch" href="/assets/js/36.7bb33ebe.js"><link rel="prefetch" href="/assets/js/37.52a5a396.js"><link rel="prefetch" href="/assets/js/38.0ebe221e.js"><link rel="prefetch" href="/assets/js/39.1015c0f8.js"><link rel="prefetch" href="/assets/js/4.da3f28c5.js"><link rel="prefetch" href="/assets/js/40.020bd197.js"><link rel="prefetch" href="/assets/js/41.65a65194.js"><link rel="prefetch" href="/assets/js/42.55cdbd80.js"><link rel="prefetch" href="/assets/js/43.8422be2c.js"><link rel="prefetch" href="/assets/js/44.33668108.js"><link rel="prefetch" href="/assets/js/45.b3ded315.js"><link rel="prefetch" href="/assets/js/46.eadeca92.js"><link rel="prefetch" href="/assets/js/47.60081668.js"><link rel="prefetch" href="/assets/js/48.8468270c.js"><link rel="prefetch" href="/assets/js/49.444245e4.js"><link rel="prefetch" href="/assets/js/5.373ed106.js"><link rel="prefetch" href="/assets/js/50.0bf638aa.js"><link rel="prefetch" href="/assets/js/51.601c1994.js"><link rel="prefetch" href="/assets/js/52.7432a82b.js"><link rel="prefetch" href="/assets/js/53.2cbb88f8.js"><link rel="prefetch" href="/assets/js/54.566e00a5.js"><link rel="prefetch" href="/assets/js/55.82bdae2c.js"><link rel="prefetch" href="/assets/js/56.352a9bcf.js"><link rel="prefetch" href="/assets/js/57.6b43514a.js"><link rel="prefetch" href="/assets/js/58.319eb472.js"><link rel="prefetch" href="/assets/js/59.5cbf1070.js"><link rel="prefetch" href="/assets/js/60.fe45dcb3.js"><link rel="prefetch" href="/assets/js/61.995eb879.js"><link rel="prefetch" href="/assets/js/62.4348c455.js"><link rel="prefetch" href="/assets/js/63.2db97682.js"><link rel="prefetch" href="/assets/js/64.c7e8215e.js"><link rel="prefetch" href="/assets/js/65.5933a627.js"><link rel="prefetch" href="/assets/js/66.1c91b950.js"><link rel="prefetch" href="/assets/js/67.56564cf6.js"><link rel="prefetch" href="/assets/js/68.8e27cc57.js"><link rel="prefetch" href="/assets/js/69.dc7a5b90.js"><link rel="prefetch" href="/assets/js/7.80766424.js"><link rel="prefetch" href="/assets/js/70.c9686c06.js"><link rel="prefetch" href="/assets/js/71.94965ca3.js"><link rel="prefetch" href="/assets/js/72.db932d40.js"><link rel="prefetch" href="/assets/js/73.219c2885.js"><link rel="prefetch" href="/assets/js/74.61dac4ea.js"><link rel="prefetch" href="/assets/js/76.033a832e.js"><link rel="prefetch" href="/assets/js/77.2b4c01f0.js"><link rel="prefetch" href="/assets/js/78.f706efe9.js"><link rel="prefetch" href="/assets/js/79.7452cf1e.js"><link rel="prefetch" href="/assets/js/8.389698f0.js"><link rel="prefetch" href="/assets/js/80.43bda541.js"><link rel="prefetch" href="/assets/js/81.cccd7099.js"><link rel="prefetch" href="/assets/js/82.127202ad.js"><link rel="prefetch" href="/assets/js/83.0d1a76a2.js"><link rel="prefetch" href="/assets/js/84.891f115c.js"><link rel="prefetch" href="/assets/js/85.daa5d9b4.js"><link rel="prefetch" href="/assets/js/86.9deeb1ca.js"><link rel="prefetch" href="/assets/js/87.42df0bbb.js"><link rel="prefetch" href="/assets/js/88.89edd320.js"><link rel="prefetch" href="/assets/js/89.478f49dc.js"><link rel="prefetch" href="/assets/js/9.92d7f2f1.js"><link rel="prefetch" href="/assets/js/90.2feb1628.js"><link rel="prefetch" href="/assets/js/91.37ccfe14.js"><link rel="prefetch" href="/assets/js/92.46cda28b.js"><link rel="prefetch" href="/assets/js/93.7d0867e8.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.7538008b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.18c2a749.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Clog </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/tech/" class="nav-link router-link-active">前端</a></li><li class="nav-item"><a href="/book/" class="nav-link">随笔</a></li><li class="nav-item"><a href="/algorithm/index.html" class="nav-link">算法</a></li><li class="nav-item"><a href="https://github.com/yuecai" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Clog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/tech/" class="nav-link router-link-active">前端</a></li><li class="mobile-nav-item"><a href="/book/" class="nav-link">随笔</a></li><li class="mobile-nav-item"><a href="/algorithm/index.html" class="nav-link">算法</a></li><li class="mobile-nav-item"><a href="https://github.com/yuecai" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div><div class="content__default"><h2 id="reactchildren-api"><a href="#reactchildren-api" class="header-anchor">#</a> ReactChildren API</h2> <p>React 提供了该API用于对每个reactElement进行遍历操作</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 该文件导出了</span>
<span class="token comment">// React.children.map </span>
<span class="token comment">// React.children.forEach</span>
<span class="token comment">// React.children.count</span>
<span class="token comment">// React.children.only</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  forEachChildren <span class="token keyword">as</span> forEach<span class="token punctuation">,</span>
  mapChildren <span class="token keyword">as</span> map<span class="token punctuation">,</span>
  countChildren <span class="token keyword">as</span> count<span class="token punctuation">,</span>
  onlyChild <span class="token keyword">as</span> only<span class="token punctuation">,</span>
  toArray<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="举例说明map和foreach如何实现"><a href="#举例说明map和foreach如何实现" class="header-anchor">#</a> 举例说明map和forEach如何实现</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/* 
* React.children.map([ReactEle, ReactEle], (c) =&gt; [c, c])
* =&gt; [ReactEle, ReactEle, ReactEle, ReactEle]
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">function</span> <span class="token function">mapChildren</span><span class="token punctuation">(</span><span class="token parameter">children<span class="token punctuation">,</span> func<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> children<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 遍历出来的元素会丢到 result 中最后返回出去</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">mapIntoWithKeyPrefixInternal</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> func<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 此处将func挂载到复用对象traverseContext上</span>
  <span class="token comment">// 将result的引用保存</span>
  <span class="token comment">// context是可选参数</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>mapIntoWithKeyPrefixInternal</code>这个函数捎带处理了每个child的key</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mapIntoWithKeyPrefixInternal</span><span class="token punctuation">(</span><span class="token parameter">children<span class="token punctuation">,</span> array<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> func<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//  处理key 略过...</span>
<span class="token comment">//  let escapedPrefix = '';</span>
<span class="token comment">//  if (prefix != null) {</span>
<span class="token comment">//    escapedPrefix = escapeUserProvidedKey(prefix) + '/';</span>
<span class="token comment">//  }</span>
  <span class="token keyword">const</span> traverseContext <span class="token operator">=</span> <span class="token function">getPooledTraverseContext</span><span class="token punctuation">(</span>
    array<span class="token punctuation">,</span> 		<span class="token comment">// result</span>
    escapedPrefix<span class="token punctuation">,</span>
    func<span class="token punctuation">,</span>
    context<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">traverseAllChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> mapSingleChildIntoContext<span class="token punctuation">,</span> traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">releaseTraverseContext</span><span class="token punctuation">(</span>traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">traverseAllChildren</span><span class="token punctuation">(</span><span class="token parameter">children<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> traverseContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">traverseAllChildrenImpl</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> callback<span class="token punctuation">,</span> traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><code>getPooledTraverseContext</code>和<code>releaseTraverseContext</code> 是用于维护一个对象池</p> <p>考虑到重新创建一个对象性能开销较大，每次用到就<code>pop</code>出一个对象，释放时就将属性置空<code>push</code>进<code>pool</code>中</p> <blockquote><p>对象池的代码放在后面</p></blockquote> <blockquote><p>在线程的复用中，也会有类似的模型</p></blockquote> <p>在<code>mapChildren</code>这个函数中<code>traverseAllChildren</code> 中传入的回调函数为<code>mapSingleChildIntoContext</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// map的回调函数</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">traverseAllChildrenImpl</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">function</span> <span class="token function">traverseAllChildrenImpl</span><span class="token punctuation">(</span>
  <span class="token parameter">children<span class="token punctuation">,</span>
  nameSoFar<span class="token punctuation">,</span>
  callback<span class="token punctuation">,</span>
  traverseContext<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这个函数核心作用就是通过把传入的 children 数组通过遍历摊平成单个节点</span>
  <span class="token comment">// 然后去执行 mapSingleChildIntoContext</span>
  <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token keyword">typeof</span> children<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'undefined'</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    children <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> invokeCallback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// 是否该调用回调函数</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    invokeCallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'string'</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token string">'number'</span><span class="token operator">:</span>
        invokeCallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'object'</span><span class="token operator">:</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>children<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token operator">:</span>      <span class="token comment">// reactElement </span>
          <span class="token keyword">case</span> <span class="token constant">REACT_PORTAL_TYPE</span><span class="token operator">:</span>
            invokeCallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果 children 是可以渲染的节点的话，就直接调用 callback</span>
  <span class="token comment">// 在map函数中， callback 是 mapSingleChildIntoContext</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>invokeCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>				
      traverseContext<span class="token punctuation">,</span>
      children<span class="token punctuation">,</span>
      <span class="token comment">// If it's the only child, treat the name as if it was wrapped in an array</span>
      <span class="token comment">// so that it's consistent if the number of children grows.</span>
      nameSoFar <span class="token operator">===</span> <span class="token string">''</span> <span class="token operator">?</span> <span class="token constant">SEPARATOR</span> <span class="token operator">+</span> <span class="token function">getComponentKey</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span> nameSoFar<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 节点是数组的话，就开始遍历数组，对数组的每个元素递归执行 traverseAllChildrenImpl</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      child <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      subtreeCount <span class="token operator">+=</span> <span class="token function">traverseAllChildrenImpl</span><span class="token punctuation">(</span>
        child<span class="token punctuation">,</span>
        nextName<span class="token punctuation">,</span> <span class="token comment">// 省略</span>
        callback<span class="token punctuation">,</span>
        traverseContext<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">// 如果不是数组，判断是不是可遍历的对象  省略</span>
    <span class="token comment">// 如果可迭代 生成迭代器执行</span>
    <span class="token keyword">const</span> iteratorFn <span class="token operator">=</span> <span class="token function">getIteratorFn</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> iteratorFn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token function">iteratorFn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>step <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// ...</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     	  <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> subtreeCount<span class="token punctuation">;</span> <span class="token comment">// 返回一个计算children层次的数字 每一层为1</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mapSingleChildIntoContext</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">function</span> <span class="token function">mapSingleChildIntoContext</span><span class="token punctuation">(</span><span class="token parameter">bookKeeping<span class="token punctuation">,</span> child<span class="token punctuation">,</span> childKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>result<span class="token punctuation">,</span> keyPrefix<span class="token punctuation">,</span> func<span class="token punctuation">,</span> context<span class="token punctuation">}</span> <span class="token operator">=</span> bookKeeping<span class="token punctuation">;</span>
	<span class="token comment">// bookKeeping 即 traverseContext</span>
  <span class="token keyword">let</span> mappedChild <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> child<span class="token punctuation">,</span> bookKeeping<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断函数返回值是否为数组</span>
  <span class="token comment">// 因为函数可能是这样c =&gt; [c, c]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>mappedChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 是数组的话就回到最先调用的函数中</span>
    <span class="token comment">// 然后回到之前 traverseAllChildrenImpl 摊平数组的问题</span>
    <span class="token comment">// 假如 c =&gt; [[c, c]]，当执行这个函数时，返回值应该是 [c, c]</span>
    <span class="token comment">// 然后 [c, c] 会被当成 children 传入</span>
    <span class="token comment">// 最后也会被flatten到 [c, c, c, c]</span>
    <span class="token function">mapIntoWithKeyPrefixInternal</span><span class="token punctuation">(</span>mappedChild<span class="token punctuation">,</span> result<span class="token punctuation">,</span> childKey<span class="token punctuation">,</span> <span class="token parameter">c</span> <span class="token operator">=&gt;</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedChild <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不是数组且返回值不为空，判断返回值是否为有效的 Element</span>
    <span class="token comment">// 是的话就把这个元素 clone 一遍并且替换掉 key</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValidElement</span><span class="token punctuation">(</span>mappedChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mappedChild <span class="token operator">=</span> <span class="token function">cloneAndReplaceKey</span><span class="token punctuation">(</span>
        mappedChild<span class="token punctuation">,</span>
        <span class="token comment">// Keep both the (mapped) and old keys if they differ, just as</span>
        <span class="token comment">// traverseAllChildren used to do for objects as children</span>
        keyPrefix <span class="token operator">+</span>
          <span class="token punctuation">(</span>mappedChild<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>child <span class="token operator">||</span> child<span class="token punctuation">.</span>key <span class="token operator">!==</span> mappedChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
            <span class="token operator">?</span> <span class="token function">escapeUserProvidedKey</span><span class="token punctuation">(</span>mappedChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span>
            <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span>
          childKey<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>mappedChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>总结：
在调用流程中持有一个<code>traverse</code>对象（从traVersePool中提取） -&gt;</p> <p><code>traverse</code>中保有一个array 保存flatten过的children -&gt;</p> <p>如果child为一个reactEelment 则调用<code>mapSingleChildIntoContext</code></p> <p>对每个为数组的child 调用<code>mapIntoWithKeyPrefixInternal</code> -&gt; <code>traverseAllChildren</code> -&gt;</p> <p><code>traverseAllChildrenImpl</code>遍历数组，传入回调函数。 该函数为map的回调函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">forEachChildren</span><span class="token punctuation">(</span><span class="token parameter">children<span class="token punctuation">,</span> forEachFunc<span class="token punctuation">,</span> forEachContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> children<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> traverseContext <span class="token operator">=</span> <span class="token function">getPooledTraverseContext</span><span class="token punctuation">(</span>
    <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token keyword">null</span><span class="token punctuation">,</span>
    forEachFunc<span class="token punctuation">,</span>
    forEachContext<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">traverseAllChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> forEachSingleChild<span class="token punctuation">,</span> traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">releaseTraverseContext</span><span class="token punctuation">(</span>traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 传入的回调函数为`forEachSingleChild`</span>
<span class="token keyword">function</span> <span class="token function">forEachSingleChild</span><span class="token punctuation">(</span><span class="token parameter">bookKeeping<span class="token punctuation">,</span> child<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>func<span class="token punctuation">,</span> context<span class="token punctuation">}</span> <span class="token operator">=</span> bookKeeping<span class="token punctuation">;</span>
  <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> child<span class="token punctuation">,</span> bookKeeping<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="对象复用池"><a href="#对象复用池" class="header-anchor">#</a> 对象复用池</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 对象重用池， 为了提高性能</span>
<span class="token keyword">const</span> traverseContextPool <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">getPooledTraverseContext</span><span class="token punctuation">(</span>
  <span class="token parameter">mapResult<span class="token punctuation">,</span>
  keyPrefix<span class="token punctuation">,</span>
  mapFunction<span class="token punctuation">,</span>
  mapContext<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>traverseContextPool<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> traverseContext <span class="token operator">=</span> traverseContextPool<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    traverseContext<span class="token punctuation">.</span>result <span class="token operator">=</span> mapResult<span class="token punctuation">;</span>
    traverseContext<span class="token punctuation">.</span>keyPrefix <span class="token operator">=</span> keyPrefix<span class="token punctuation">;</span>
    traverseContext<span class="token punctuation">.</span>func <span class="token operator">=</span> mapFunction<span class="token punctuation">;</span>
    traverseContext<span class="token punctuation">.</span>context <span class="token operator">=</span> mapContext<span class="token punctuation">;</span>
    traverseContext<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> traverseContext<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      result<span class="token operator">:</span> mapResult<span class="token punctuation">,</span>
      keyPrefix<span class="token operator">:</span> keyPrefix<span class="token punctuation">,</span>
      func<span class="token operator">:</span> mapFunction<span class="token punctuation">,</span>
      context<span class="token operator">:</span> mapContext<span class="token punctuation">,</span>
      count<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">releaseTraverseContext</span><span class="token punctuation">(</span><span class="token parameter">traverseContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  traverseContext<span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  traverseContext<span class="token punctuation">.</span>keyPrefix <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  traverseContext<span class="token punctuation">.</span>func <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  traverseContext<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  traverseContext<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>traverseContextPool<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token constant">POOL_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    traverseContextPool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>traverseContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div></div></div></div> <footer class="footer" data-v-582f9766><div class="footer-left-wrap" data-v-582f9766><ul class="contact" data-v-582f9766></ul></div> <div class="footer-right-wrap" data-v-582f9766><ul class="copyright" data-v-582f9766></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.4b1e1b3d.js" defer></script><script src="/assets/js/6.90d8b0a4.js" defer></script><script src="/assets/js/13.d71f7fb4.js" defer></script><script src="/assets/js/75.9cd96759.js" defer></script>
  </body>
</html>
